/***********************************************************************************************************/
/***********************************************************************************************************/
/***********************************************************************************************************/
/***********************************************************************************************************/
/*****************                                                                       *******************/
/****************                    Программа чтения протокола ОЛ                        ******************/
/*****************                                                                       *******************/
/***********************************************************************************************************/
/***********************************************************************************************************/
/***********************************************************************************************************/
/***********************************************************************************************************/
/*идентификатор компа*/ *D - sony, Z - ГНЦ;
*Без предефайна оказывается не работает;
%let disk = .;
%let lastname= .;
%macro what_OC;
%if &sysscpl = W32_7PRO %then 
	%do;
		%let disk = C:\Users\user\Documents\GitHub\AL; *sony;
	%end;
%else/*%if &sysscpl = "W32_7PRO" %then */ 
	%do;
		%let disk = Z:\AC\AL; *остальные;
	%end;
%mend;


/*определитель ОС*/
/*data comp;*/
/*	OC = "&sysscpl";*/
/*run;*/
/**/
/*proc print data = COMP;*/
/*run;*/
%what_OC;

%let dirURI = &disk.\CurBase\; * директория с базой;
%let metaFN = meta.txt; * имя файла метаданных;
%let LN = AL; * имя библиотеки;
%let lbs = labels.txt; * файл с лейблами (для всех таблиц в кучу);

Libname &LN "&disk.\SAS"; * создали файл данных;
filename tranfile "&disk.\REG_ARCH_&sysdate9..stc"; * условный идентификатор транспортного файла;

/***********************************************************************************************************/
/************************************* формат фала метаданных **********************************************/
/**                                                                                                       **/
/**    имя файла ***** табуляция ***** имя датасета                                                       **/
/**                                                                                                       **/
/***********************************************************************************************************/

OPTIONS CTRYDECIMALSEPARATOR=',' ;

*Импортируем файл метаданных;
proc import datafile="&dirURI&metaFN" dbms=tab out=&LN..TABLES replace; 
	*delimiter='09'x; * разделитель -- '09'x табуляция;
	getnames=yes; * получать имена переменных?;
run; 

*Макрос импорта данных из таб-делиметед файлов;
%macro imprt (src, dst);
	proc import datafile="&dirURI&src" dbms=csv out=&LN..&dst replace; 
		*delimiter='09'x; * разделитель -- '09'x табуляция;
		delimiter=';';
		getnames=yes; * получать имена переменных?;
		guessingrows=500;  * как много строк нужно просканировать, для определения максемальной длинны поля;
	run; 
%mend imprt;


%macro lbls (tn);
data &LN..&tn;
	SET &LN..&tn;
%include "&dirURI&lbs";
run;
%mend;

*для каждой записи метафайла выполняем макрос экспорта;
data _Null_; * Не создаем ни какого датасета;
	set &LN..TABLES; * для работы берем таблицу метаданных;
	CALL execute ('%imprt('||FN||','||TN||')'); * выполнить макрос экспорта;
	CALL execute ('%lbls('||TN||')'); * выполнить макрос присвоения лейбалов;
run; 

*загоняем в транспортный файл;
proc cport library=&LN file=tranfile;
run;

